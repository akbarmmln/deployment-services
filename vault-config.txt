--install diluar cluster kubernetes
wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install vault
--setelah itu di kubernetes-cluster nya
helm install vault-injector hashicorp/vault \
  --namespace vault \
  --set server.enabled=false \
  --set injector.enabled=true \
  --set injector.externalVaultAddr=<ip-public-vault>:8200

--konfigurasikan setelah install
file konfigurasi ada di -> /etc/vault.d/vault.hcl

vault auth enable kubernetes
vault write auth/kubernetes/config \
  token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
  kubernetes_host="https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT" \
  kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

vault secrets enable -path=DARU kv-v2
vault kv put DARU/SIT/msaccount DB_USER="admin" DB_PASS="s3cret"

# superadmin.hcl
path "*" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
# daru-sit-policy.hcl
path "DARU/data/*" {
  capabilities = ["create", "read", "update", "delete", "list"]
}
path "DARU/metadata/*" {
  capabilities = ["read", "list"]
}
vault policy write daru-sit-policy ./daru-sit-policy.hcl
vault policy write superadmin ./superadmin.hcl

vault write auth/kubernetes/role/daru-sit \
  bound_service_account_names=vault-auth \
  bound_service_account_namespaces=sit \
  policies=daru-sit-policy \
  ttl=24h

vault auth enable userpass
vault write auth/userpass/users/root \
  password="root" \
  policies="superadmin"
vault write auth/userpass/users/devops \
  password="devops" \
  policies="daru-sit-policy"

vault operator init
vault operator unseal <key1-5>

-> for uninstall -- helm uninstall vault -n vault

-> vault-auth-service-account.yaml
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: vault-auth
      namespace: sit
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: role-tokenreview-binding
      namespace: sit
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: system:auth-delegator
    subjects:
    - kind: ServiceAccount
      name: vault-auth
      namespace: sit

-> vault-auth-secret.yaml
    apiVersion: v1
    kind: Secret
    metadata:
      name: vault-auth-secret
      namespace: sit
      annotations:
        kubernetes.io/service-account.name: vault-auth
    type: kubernetes.io/service-account-token

======= konfigurasi Vault Cluster dengan Consul =======
node 1 : 47.237.117.191 node 2 : 47.237.117.192 node 3 : 47.237.117.193 (sebagai load balancer nya)

1.  Instalasi & Konfigurasi Consul (di semua node)
1.1 Download & Install Consul
    sudo apt update
    sudo apt install unzip curl -y

    # Download Consul
    CONSUL_VERSION="1.16.2"
    curl -O https://releases.hashicorp.com/consul/${CONSUL_VERSION}/consul_${CONSUL_VERSION}_linux_amd64.zip
    unzip consul_${CONSUL_VERSION}_linux_amd64.zip
    sudo mv consul /usr/local/bin/
    consul -v

    -- atau dengan cara (simpan dengan nama install_latest_consul.sh -> chmod +x install_latest_consul.sh)
    #!/bin/bash

    # Ambil versi terbaru Consul dari situs HashiCorp
    CONSUL_VERSION=$(curl -s https://releases.hashicorp.com/consul/ | grep -oP 'consul/\K[0-9]+\.[0-9]+\.[0-9]+' | head -1)

    # Tampilkan versi yang akan didownload
    echo "Consul version terbaru: $CONSUL_VERSION"

    # Download file ZIP
    curl -O https://releases.hashicorp.com/consul/${CONSUL_VERSION}/consul_${CONSUL_VERSION}_linux_amd64.zip

    # Ekstrak dan install
    unzip consul_${CONSUL_VERSION}_linux_amd64.zip
    sudo mv consul /usr/local/bin/
    rm consul_${CONSUL_VERSION}_linux_amd64.zip

    # Cek versi terinstal
    consul -v
1.2 Buat direktori konfigurasi Consul (di semua node)
    sudo mkdir -p /etc/consul.d /opt/consul
    sudo useradd --system --home /etc/consul.d --shell /bin/false consul
    sudo chown -R consul:consul /etc/consul.d /opt/consul
1.3 Konfigurasi Consul (di semua node)
    -> /etc/consul.d/consul.hcl
    datacenter = "dc1"
    node_name = "nodex"
    server = true
    bootstrap_expect = 2
    data_dir = "/opt/consul"
    bind_addr = "0.0.0.0"
    advertise_addr = "IP_PUBLIC"
    retry_join = ["IP_PUBLIC_NODE_LAIN"]
    ui = true
1.4 Service Systemd Consul (di semua node)
    -> /etc/systemd/system/consul.service
    [Unit]
    Description=Consul
    Requires=network-online.target
    After=network-online.target

    [Service]
    User=consul
    Group=consul
    ExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/
    ExecReload=/bin/kill -HUP $MAINPID
    KillMode=process
    Restart=on-failure

    [Install]
    WantedBy=multi-user.target
1.5 Start Consul (di semua node)
    sudo systemctl daemon-reexec
    sudo systemctl enable consul
    sudo systemctl start consul

JIKA DIBUTUHKAN DALAM PENGECEKAN DAN LAIN LAIN NYA
-> consul validate /etc/consul.d/
-> sudo systemctl stop consul kemudian sudo rm -rf /opt/consul/* dan sudo systemctl start consul


2.  Instalasi & Konfigurasi Vault (di semua node)
2.1 Install Vault
    sudo apt update
    sudo apt install unzip curl -y

    VAULT_VERSION="1.16.0"
    curl -O https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip
    unzip vault_${VAULT_VERSION}_linux_amd64.zip
    sudo mv vault /usr/local/bin/
    vault -v

    -- atau dengan cara (simpan dengan nama install_latest_vault.sh -> chmod +x install_latest_vault.sh)
    #!/bin/bash

    # Ambil versi terbaru Vault dari situs HashiCorp
    VAULT_VERSION=$(curl -s https://releases.hashicorp.com/vault/ | grep -oP 'vault/\K[0-9]+\.[0-9]+\.[0-9]+' | head -1)

    # Tampilkan versi yang akan didownload
    echo "Vault version terbaru: $VAULT_VERSION"

    # Download file ZIP
    curl -O https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip

    # Ekstrak dan install
    unzip vault_${VAULT_VERSION}_linux_amd64.zip
    sudo mv vault /usr/local/bin/
    rm vault_${VAULT_VERSION}_linux_amd64.zip

    # Cek versi terinstal
    vault -v
2.2 Buat direktori dan user Vault
    sudo mkdir -p /etc/vault.d /opt/vault
    sudo useradd --system --home /etc/vault.d --shell /bin/false vault
2.3 Konfigurasi Vault
    -> /etc/vault.d/vault.hcl
    ui = true
    api_addr = "<IP_PUBLIC>:8200"
    cluster_addr = "<IP_PUBLIC>:8201"
    listener "tcp" {
        address     = "0.0.0.0:8200"
        tls_disable = 1
    }
    storage "consul" {
        address = "127.0.0.1:8500"
        path    = "vault/"
    }
    disable_mlock = true
2.4 Service systemd Vault
    -> /etc/systemd/system/vault.service
    [Unit]
    Description=Vault
    Requires=network-online.target
    After=network-online.target

    [Service]
    User=vault
    Group=vault
    ExecStart=/usr/local/bin/vault server -config=/etc/vault.d/vault.hcl
    ExecReload=/bin/kill -HUP $MAINPID
    KillMode=process
    Restart=on-failure
    LimitNOFILE=65536

    [Install]
    WantedBy=multi-user.target
2.5 Start Vault
    sudo systemctl daemon-reexec
    sudo systemctl enable vault
    sudo systemctl start vault

3   Load Balancer (HAProxy)
    -> /etc/haproxy/haproxy.cfg
    frontend vault_frontend
        bind *:8200
        default_backend vault_backend

    backend vault_backend
        balance roundrobin
        option httpchk GET /v1/sys/health
        http-check expect status 200
        server node1 <IP_PUBLIC>:8200 check
        server node2 <IP_PUBLIC>:8200 check

4   Inisialisasi dan Unseal Vault (Lakukan di satu node saja):
    export VAULT_ADDR='http://<IP_PUBLIC>:8200'
    vault operator init
    NOTES: Simpan unseal keys dan root token
4.1 Verifikasi
    vault status

NOTED JIKA ADA SECURITY GROUP ATAU FIREWALL AKTIF, PERLU DILAKUKAN PENYESUAIN TERHADAP PORT BERIKUT: 8200, 8300, 8301, 8500, 8600, 8302
